# syntax=docker/dockerfile:1
# Note: valid CUDA+cudnn tags include the cudnn major version (e.g., cudnn8)
FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    ffmpeg \
    git \
    curl \
    libsndfile1 \
    libportaudio2 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY pyproject.toml README.md LICENSE ./
COPY configs ./configs
COPY scripts ./scripts
COPY src ./src
COPY data ./data

RUN python3 -m pip install -U pip wheel setuptools \
 && python3 -m pip install -q \
      typer[all] \
      pyyaml \
      sounddevice \
      numpy \
      tqdm \
      faster-whisper \
      llama-cpp-python==0.2.86 \
 && python3 -m pip install -q \
      torch==2.3.0+cu121 \
      torchvision==0.18.0+cu121 \
      --extra-index-url https://download.pytorch.org/whl/cu121 \
 && python3 -m pip install -e .

ENTRYPOINT ["meeting-notes"]
CMD ["--help"]
